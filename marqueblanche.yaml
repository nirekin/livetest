name: marqueblanche
qualifier: dev

ekara:
  distribution:
    repository: nirekin/distribution
  components:
    visualizer:
      repository: ekara-platform/swarm-visualizer-stack
    marqueblanche:
      repository: https://github.psa-cloud.com/trk00/marqueblanche
      ref: lagoon  
      auth:
        method: basic
        user: {{ .git.user }}
        password: {{ .git.password }}
    ek-core:
      repository: ekara-platform/core-stack
    ek-aws:
      repository: ekara-platform/aws-provider
    ek-openstack:
      repository: ekara-platform/openstack-provider
    ek-swarm:
      repository: ekara-platform/swarm-orchestrator        
        
orchestrator:
  component: ek-swarm
  docker:
    params:
      log-driver: json-file
      log-opts:
        max-size: "20m"
        max-file: "3"
      disable-legacy-registry: true
      userland-proxy: true
      live-restore: false
      hosts:
        - "unix:///var/run/docker.sock"
        - "tcp://0.0.0.0:2376"
      tls: true
      tlscacert: "/etc/docker/certs/ca.pem"
      tlscert: "/etc/docker/certs/cert.pem"
      tlskey: "/etc/docker/certs/key.pem"
      tlsverify: true

providers:
  ek-aws:
    component: ek-aws
    params:
      instance_type: "t3a.xlarge"
      ami_id: "ami-f90a4880"
      vpc_id: "vpc-880aeaef"
      region: {{ .aws_region }}
    env:
      AWS_REGION: {{ .aws.region }}
      AWS_ACCESS_KEY_ID: {{ .aws.accessKey.id }}
      AWS_SECRET_ACCESS_KEY: {{ .aws.accessKey.secret }}
    params:
      security_groups:
        - name: ek-ssh
          rules:
            - proto: tcp
              ports:
                - 22
              cidr_ip: 0.0.0.0/0
              rule_desc: Node SSH access
        - name: ek-swarm
          rules:
            - proto: tcp
              ports:
                - 2377
              cidr_ip: 0.0.0.0/0
              rule_desc: Swarm cluster management communications
            - proto: tcp
              ports:
                - 7946
              cidr_ip: 0.0.0.0/0
              rule_desc: Swarm communication among nodes
            - proto: udp
              ports:
                - 7946
              cidr_ip: 0.0.0.0/0
              rule_desc: Swarm communication among nodes
            - proto: udp
              ports:
                - 4789
              cidr_ip: 0.0.0.0/0
              rule_desc: Swarm overlay network traffic      
      
nodes:
  mongoN1:
    instances: 1
    provider:
      name: ek-aws
    volumes:
      - path: /users/trk00/tmp
        params:
          device_name: xvdf
          volume_type: gp2
          volume_size: 9
          delete_on_termination: true
      - path: /users/trk00/data
        params:
          device_name: xvdf
          volume_type: gp2
          volume_size: 9
          delete_on_termination: true
      - path: /data1
        params:
          device_name: xvdf
          volume_type: gp2
          volume_size: 9
          delete_on_termination: true
      - path: /var/lib/docker
        params:
          device_name: xvdg
          volume_type: standard
          volume_size: 1
          delete_on_termination: true
          tags:
            Type: Docker
            TestTagKey: TestTagValue
    labels:
      node_name: mongoN1
  mongoN2:
    instances: 1
    provider:
      name: ek-aws
    volumes:
      - path: /users/trk00/tmp
        params:
          device_name: xvdf
          volume_type: gp2
          volume_size: 9
          delete_on_termination: true
      - path: /users/trk00/data
        params:
          device_name: xvdf
          volume_type: gp2
          volume_size: 9
          delete_on_termination: true
      - path: /data1
        params:
          device_name: xvdf
          volume_type: gp2
          volume_size: 9
          delete_on_termination: true
      - path: /var/lib/docker
        params:
          device_name: xvdg
          volume_type: standard
          volume_size: 1
          delete_on_termination: true
          tags:
            Type: Docker
            TestTagKey: TestTagValue
    labels:
      node_name: mongoN2
  mongoN3:
    instances: 1
    provider:
      name: ek-aws
    volumes:
      - path: /users/trk00/tmp
        params:
          device_name: xvdf
          volume_type: gp2
          volume_size: 9
          delete_on_termination: true
      - path: /users/trk00/data
        params:
          device_name: xvdf
          volume_type: gp2
          volume_size: 9
          delete_on_termination: true
      - path: /data1
        params:
          device_name: xvdf
          volume_type: gp2
          volume_size: 9
          delete_on_termination: true
      - path: /var/lib/docker
        params:
          device_name: xvdg
          volume_type: standard
          volume_size: 1
          delete_on_termination: true
          tags:
            Type: Docker
            TestTagKey: TestTagValue
    labels:
      node_name: mongoN3

stacks:
  visualizer:
    component: visualizer
  marqueblanche:
    component: marqueblanche
  ek-core:
    component: ek-core
